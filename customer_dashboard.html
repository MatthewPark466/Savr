<script type="module">
import { db, auth, onAuthChange, setDoc, doc, collection, serverTimestamp, getDocs, getDoc, logout } from './firebase.js';

onAuthChange(async (user) => {
  if (!user) {
    window.location.href = "login.html"; // not back to customer page
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));
  if (snap.exists() && snap.data().role === "customer") {
    loadRestaurants();
  } else {
    alert("You are not authorized for this page.");
    window.location.href = "restaurant-dashboard.html";
  }
});

async function loadRestaurants() {
  const restaurantsRef = collection(db, "restaurants");
  const snapshot = await getDocs(restaurantsRef);

  const listContainer = document.querySelector('.restaurant-list');
  listContainer.innerHTML = '';

  for (let rDoc of snapshot.docs) {
    const rId = rDoc.id;
    const rName = rDoc.data().name || "Restaurant";

    const menuRef = collection(db, "restaurants", rId, "menu");
    const menuSnap = await getDocs(menuRef);

    menuSnap.docs.forEach(itemDoc => {
      const item = itemDoc.data();
      const card = document.createElement('div');
      card.className = 'restaurant-card';
      card.innerHTML = `
        <h3>${rName}</h3>
        <p>${item.name} â€” $${item.price} (${item.quantity} left)</p>
        <button>Order Now</button>
      `;
      listContainer.appendChild(card);

      card.querySelector('button').addEventListener('click', async () => {
        const orderId = Date.now().toString();
        await setDoc(doc(db, "orders", orderId), {
          customerId: auth.currentUser.uid,
          restaurantId: rId,
          itemName: item.name,
          price: item.price,
          quantity: 1,
          createdAt: serverTimestamp()
        });
        alert(`Ordered ${item.name} from ${rName} for $${item.price}`);
      });
    });
  }
}

// logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await logout();
  window.location.href = "login.html";
});
</script>
